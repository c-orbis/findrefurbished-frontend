---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Debug - Vind Refurbished">
  <main class="max-w-4xl mx-auto p-10">
    <h1 class="text-2xl font-bold mb-5">Zoekmachine Debug Mode</h1>
    <div id="searchbox" class="mb-5 border p-2"></div>
    <div id="hits"></div>
  </main>

  <div id="meili-data" 
       data-host={import.meta.env.PUBLIC_MEILI_HOST} 
       data-key={import.meta.env.PUBLIC_MEILI_SEARCH_KEY}>
  </div>
</Layout>

<script is:inline src="https://cdn.jsdelivr.net/npm/@meilisearch/instant-meilisearch/dist/instant-meilisearch.umd.min.js"></script>
<script is:inline src="https://cdn.jsdelivr.net/npm/instantsearch.js@4"></script>

<script is:inline>
  function startEngine() {
    const dataEl = document.getElementById('meili-data');
    if (!dataEl) return;

    const host = dataEl.dataset.host.replace('http://', 'https://');
    const key = dataEl.dataset.key;

    console.log("--- ENGINE START ---");

    // Haal de juiste library op uit het browsergeheugen
    const IMS = window.instantMeiliSearch?.instantMeiliSearch || window.instantMeiliSearch;
    
    if (typeof IMS !== 'function') {
      console.error("Kritieke fout: Meilisearch functies niet gevonden.");
      return;
    }

        // AGRESSIEVE INITIALISATIE
    let client = (typeof IMS.instantMeiliSearch === 'function') 
      ? IMS.instantMeiliSearch(host, key) 
      : (typeof IMS === 'function' ? IMS(host, key) : IMS);

    // We forceren de search methode door diep in het object te graven
    const searchClient = {
      search(requests) {
        // We zoeken de echte functie, waar hij ook verstopt zit
        const actualSearch = client.search || 
                             (client.instantMeiliSearch && client.instantMeiliSearch.search) ||
                             (typeof client === 'function' ? client : null);
        
        if (!actualSearch || typeof actualSearch !== 'function') {
          console.error("KRITIEKE FOUT: De search-methode is onvindbaar in de geladen scripts.", client);
          return Promise.reject("Search method missing");
        }
        return actualSearch(requests);
      },
      searchForFacetValues(requests) {
        const facetFn = client.searchForFacetValues || (client.instantMeiliSearch && client.instantMeiliSearch.searchForFacetValues);
        return facetFn ? facetFn(requests) : undefined;
      }
    };

    search.addWidgets([
      instantsearch.widgets.searchBox({ 
        container: '#searchbox',
        placeholder: 'Zoek op model...' 
      }),
      instantsearch.widgets.hits({
        container: '#hits',
        templates: {
          item: (hit) => `<div>✅ Succes: ${hit.title_h1 || 'Product'}</div>`,
          empty: '❌ Geen producten gevonden in index "products".'
        }
      })
    ]);

    search.on('render', () => {
      const results = search.helper.lastResults;
      console.log("Aantal resultaten gevonden:", results ? results.nbHits : "laden...");
    });

    try {
      search.start();
      console.log("Engine draait!");
    } catch (err) {
      console.error("Crash tijdens starten:", err);
    }
  }

  // Wacht tot de scripts geladen zijn
  if (document.readyState === 'complete') {
    setTimeout(startEngine, 500);
  } else {
    window.addEventListener('load', () => setTimeout(startEngine, 500));
  }
</script>

