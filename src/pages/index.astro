---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Debug - Vind Refurbished">
  <main class="max-w-4xl mx-auto p-10">
    <h1 class="text-2xl font-bold mb-5">Zoekmachine Debug Mode</h1>
    <div id="searchbox" class="mb-5 border p-2"></div>
    <div id="hits"></div>
  </main>

  <div id="meili-data" 
       data-host={import.meta.env.PUBLIC_MEILI_HOST} 
       data-key={import.meta.env.PUBLIC_MEILI_SEARCH_KEY}>
  </div>
</Layout>

<script>
  import { instantMeiliSearch } from '@meilisearch/instant-meilisearch';
  import instantsearch from 'instantsearch.js';
  import { searchBox, hits, refinementList } from 'instantsearch.js/es/widgets';

  function init() {
    const dataEl = document.getElementById('meili-data');
    if (!dataEl) return;

    const host = dataEl.dataset.host?.replace('http://', 'https://');
    const key = dataEl.dataset.key;
    if (!host || !key) return;

    // We initialiseren de client
    const client = instantMeiliSearch(host, key);

    // DIT IS DE OPLOSSING: We bouwen een proxy-client die ALTIJD werkt
    const searchClient = {
      ...client,
      search(requests) {
        if (requests.every(({ params }) => !params.query)) {
          return Promise.resolve({
            results: requests.map(() => ({
              hits: [],
              nbHits: 0,
              nbPages: 0,
              page: 0,
              processingTimeMS: 0,
              hitsPerPage: 0,
              exhaustiveNbHits: true,
              query: '',
              params: '',
              index: '',
            })),
          });
        }
        return client.search(requests);
      },
    };

    const search = instantsearch({
      indexName: 'products',
      searchClient, // Gebruik onze proxy-client
      future: { preserveSharedStateOnUnmount: true }
    });

    search.addWidgets([
      searchBox({ container: '#searchbox', placeholder: 'Zoek op model...' }),
      refinementList({ container: '#brand-filter', attribute: 'brand' }),
      hits({
        container: '#hits',
                templates: {
          item: (hit) => `
            <div class="p-4 border mb-2 bg-white rounded-xl shadow-sm flex items-center gap-4">
              <img src="https://img.findrefurbished.com/${hit.master_id}.png" class="w-16 h-16 object-contain" onerror="this.src='https://placehold.co'" />
              <div class="flex-grow">
                <div class="font-bold text-gray-900 leading-tight">${hit.title_h1}</div>
                <div class="text-xs text-gray-400 uppercase font-bold tracking-wider mt-1">${hit.brand}</div>
              </div>
              <div class="text-right">
                <div class="text-2xl font-black text-blue-600 leading-none">€${Number(hit.min_price).toFixed(2)}</div>
                <a href="/product/${hit.variant_slug}" class="text-[10px] text-blue-500 font-bold hover:underline">Bekijk deals</a>
              </div>
            </div>
          `,
          empty: '<div class="p-10 text-center text-gray-500 italic">❌ Geen producten gevonden.</div>'
        }
      })
    ]);

    search.start();
  }

  // Luister naar zowel de eerste load als de transities van Astro
  document.addEventListener('astro:page-load', init);
  init();
</script>
