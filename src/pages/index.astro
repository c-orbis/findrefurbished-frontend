<script>
  import { instantMeiliSearch } from '@meilisearch/instant-meilisearch';
  import instantsearch from 'instantsearch.js';
  import { searchBox, hits, refinementList } from 'instantsearch.js/es/widgets';

  function init() {
    console.log("Start initialisatie zoekmachine...");
    
    const dataEl = document.getElementById('meili-data');
    if (!dataEl) {
      console.error("Data element #meili-data niet gevonden!");
      return;
    }

    const { host, key } = dataEl.dataset;
    console.log("Verbinden met host:", host);

    const searchClient = instantMeiliSearch(host, key);
    const search = instantsearch({
      indexName: 'products',
      searchClient,
    });

    search.addWidgets([
      searchBox({ container: '#searchbox', placeholder: 'Zoek op model...' }),
      refinementList({ container: '#category-filter', attribute: 'category_primary' }),
      refinementList({ container: '#brand-filter', attribute: 'brand' }),
      refinementList({ container: '#condition-filter', attribute: 'offers.condition' }),
      hits({
        container: '#hits',
        templates: {
          empty: '<p class="p-8 text-center text-gray-500">Geen producten gevonden voor deze zoekopdracht.</p>',
          item: (hit) => `
            <div class="flex items-center gap-6 bg-white border p-5 rounded-2xl mb-4 shadow-sm hover:shadow-md transition-shadow">
              <div class="w-24 h-24 flex-shrink-0 flex items-center justify-center">
                <img src="https://img.findrefurbished.com/${hit.master_id}.png" class="max-h-full" onerror="this.src='https://placehold.co'" />
              </div>
              <div class="flex-grow">
                <h2 class="text-xl font-bold text-gray-900">${hit.title_h1}</h2>
                <p class="text-gray-500 text-sm uppercase font-semibold">${hit.brand} • ${hit.category_primary}</p>
              </div>
              <div class="text-right">
                <div class="text-3xl font-black text-blue-600">€${hit.min_price}</div>
                <a href="/product/${hit.variant_slug}" class="inline-block mt-3 bg-blue-600 text-white px-6 py-2 rounded-xl font-bold">Bekijk</a>
              </div>
            </div>
          `,
        },
      }),
    ]);

    search.start();
    console.log("Zoekmachine gestart!");
  }

  // Zorg dat Astro dit script pas uitvoert als de DOM klaar is
  document.addEventListener('astro:page-load', init);
  // Fallback voor de eerste keer laden
  init();
</script>
