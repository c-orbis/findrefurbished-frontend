---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Vind Refurbished - Vergelijk alle prijzen">
  <main class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-4xl font-black mb-8 text-gray-900 leading-tight tracking-tight">Vind Refurbished</h1>
    
    <!-- Zoekbalk -->
    <div id="searchbox" class="mb-8"></div>

    <div class="flex flex-col md:flex-row gap-10">
      <!-- Sidebar voor filters -->
      <aside class="w-full md:w-64 space-y-6">
        <div>
          <h3 class="font-bold mb-2 text-gray-400 uppercase text-xs tracking-widest italic">Merk</h3>
          <div id="brand-filter"></div>
        </div>
      </aside>

      <!-- Resultaten -->
      <div class="flex-grow">
        <div id="hits"></div>
      </div>
    </div>
  </main>

  <!-- Data element (slechts Ã©Ã©n keer nodig) -->
  <div id="meili-data" 
       data-host={import.meta.env.PUBLIC_MEILI_HOST} 
       data-key={import.meta.env.PUBLIC_MEILI_SEARCH_KEY}>
  </div>
</Layout>

<!-- 1. Verwijder alle andere script-tags en imports uit je bestand -->
<script is:inline src="https://cdn.jsdelivr.net/npm/@meilisearch/instant-meilisearch/dist/instant-meilisearch.umd.min.js"></script>
<script is:inline src="https://cdn.jsdelivr.net/npm/instantsearch.js@4"></script>

<script is:inline>
  async function startSearch() {
    const dataEl = document.getElementById('meili-data');
    if (!dataEl) return;

    const host = dataEl.dataset.host.replace('http://', 'https://');
    const key = dataEl.dataset.key;

    // DE ULTIEME FIX: We bouwen de search methode handmatig via fetch
    // Dit omzeilt alle adapter-fouten
    const searchClient = {
      async search(requests) {
        const { indexName, params } = requests[0];
        const response = await fetch(`${host}/indexes/${indexName}/search`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${key}`
          },
          body: JSON.stringify({
            q: params.query,
            limit: params.hitsPerPage || 20,
            filter: params.filters || "",
            facets: ["brand", "category_primary", "offers.condition"]
          })
        });
        const data = await response.json();
        
        // Vertaal Meilisearch output naar InstantSearch formaat
        return {
          results: requests.map(() => ({
            hits: data.hits,
            nbHits: data.estimatedTotalHits,
            nbPages: Math.ceil(data.estimatedTotalHits / 20),
            page: 0,
            processingTimeMS: data.processingTimeMs,
            hitsPerPage: 20,
            query: params.query,
            facets: data.facetDistribution,
            exhaustiveNbHits: true
          }))
        };
      }
    };

    const search = instantsearch({
      indexName: 'products',
      searchClient: searchClient,
    });

    search.addWidgets([
      instantsearch.widgets.searchBox({ container: '#searchbox', placeholder: 'Zoek op model...' }),
      instantsearch.widgets.hits({
        container: '#hits',
        templates: {
          item: (hit) => `
            <div class="p-4 border border-gray-200 mb-2 bg-white rounded-xl shadow-sm flex items-center gap-4">
              
              <img src={`https://img.findrefurbished.com/${hit.master_id}.png`} class="w-16 h-16 object-contain" onerror="this.src='https://placehold.co/200x200?text=Geen+Foto'"/>

                <div class="flex-grow">
                <div class="font-bold text-gray-900 leading-tight">${hit.title_h1}</div>
                <div class="text-[10px] text-gray-400 uppercase font-bold tracking-widest mt-1">${hit.brand}</div>
              </div>
              <div class="text-right min-w-[100px]">
                <div class="text-2xl font-black text-blue-600 leading-none">â‚¬${Number(hit.min_price).toFixed(2)}</div>
                <a href="/product/${hit.variant_slug}" class="inline-block mt-2 text-[11px] text-blue-600 font-bold hover:underline">Bekijk deals</a>
              </div>
            </div>
          `,
          empty: '<div class="p-10 text-center text-gray-500 italic">âŒ Geen producten gevonden.</div>'
        }
      })
    ]);

    search.start();
    console.log("ğŸš€ Handmatige Search Engine gestart!");
  }

  window.addEventListener('load', startSearch);
  document.addEventListener('astro:page-load', startSearch);
</script>
