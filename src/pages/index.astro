---
import Layout from "../layouts/Layout.astro";
---

<Layout
  title="Find Refurbished - Vergelijk prijzen van refurbished iPhones & MacBooks"
  description="Bespaar tot 40% op je volgende aankoop. Vergelijk live prijzen van alle grote refurbished aanbieders op één plek met de snelste vergelijker van Nederland."
>
  <main class="max-w-7xl mx-auto px-4 py-8">
    <h1
      class="text-4xl font-black mb-8 text-gray-900 leading-tight tracking-tight"
    >
      Vind Refurbished
    </h1>

    <!-- Zoekbalk -->
    <div id="searchbox" class="mb-8 min-h-[64px]"></div>

    <div class="flex flex-col md:flex-row gap-10">
      <!-- Sidebar voor filters -->
      <aside class="w-full md:w-64 space-y-8">
        <div>
          <h3
            class="font-bold mb-4 text-gray-900 uppercase text-[10px] tracking-widest italic border-b pb-2 border-gray-100"
          >
            Merk
          </h3>
          <div id="brand-filter"></div>
        </div>

        <div>
          <h3
            class="font-bold mb-4 text-gray-900 uppercase text-[10px] tracking-widest italic border-b pb-2 border-gray-100"
          >
            Conditie
          </h3>
          <div id="condition-filter"></div>
        </div>
      </aside>

      <!-- Resultaten -->
      <div class="flex-grow">
        <div id="hits" class="min-h-[1000px]">
          <div class="p-10 text-center text-gray-400 animate-pulse">
            Producten laden...
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Data element voor API configuratie -->
  <div
    id="meili-data"
    data-host={import.meta.env.PUBLIC_MEILI_HOST}
    data-key={import.meta.env.PUBLIC_MEILI_SEARCH_KEY}
  >
  </div>
</Layout>

<!-- Scripts via CDN -->
<script
  is:inline
  src="https://cdn.jsdelivr.net/npm/@meilisearch/instant-meilisearch/dist/instant-meilisearch.umd.min.js"
></script>
<script is:inline src="https://cdn.jsdelivr.net/npm/instantsearch.js@4"
></script>

<script is:inline>
  async function startSearch() {
    const dataEl = document.getElementById("meili-data");
    if (!dataEl) return;

    const host = dataEl.dataset.host.replace("http://", "https://");
    const key = dataEl.dataset.key;

    // Custom SearchClient voor directe API communicatie
    const searchClient = {
      async search(requests) {
        const responses = await Promise.all(
          requests.map(async (request) => {
            const { indexName, params } = request;

            let filterString = params.filters || "";
            if (!filterString && params.facetFilters) {
              filterString = params.facetFilters
                .map((f) =>
                  Array.isArray(f)
                    ? `(${f.map((v) => v.replace(":", " = ")).join(" OR ")})`
                    : f.replace(":", " = "),
                )
                .join(" AND ");
            } else {
              filterString = filterString.replace(/:/g, " = ");
            }

            const res = await fetch(`${host}/indexes/${indexName}/search`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${key}`,
              },
              body: JSON.stringify({
                q: params.query || "",
                limit: 20,
                filter: filterString,
                facets: ["brand", "offers.condition"],
              }),
            });

            const data = await res.json();

            return {
              hits: data.hits,
              nbHits: data.estimatedTotalHits || data.hits.length,
              nbPages: 1,
              page: params.page || 0,
              processingTimeMS: data.processingTimeMs,
              hitsPerPage: 20,
              query: params.query,
              facets: data.facetDistribution,
              exhaustiveNbHits: true,
            };
          }),
        );
        return { results: responses };
      },
    };

    const search = instantsearch({
      indexName: "products",
      searchClient: searchClient,
    });

    search.addWidgets([
      instantsearch.widgets.searchBox({
        container: "#searchbox",
        placeholder: "Zoek op model (bijv. iPhone 15 Pro)...",
      }),

      instantsearch.widgets.refinementList({
        container: "#brand-filter",
        attribute: "brand",
        templates: {
          item: `
            <label class="flex items-center gap-2 cursor-pointer py-1 group">
              <input type="checkbox" class="rounded border-gray-300" {{#isRefined}}checked{{/isRefined}} />
              <span class="text-sm {{#isRefined}}font-bold text-blue-600{{/isRefined}} group-hover:text-blue-500">{{label}}</span>
              <span class="text-[10px] text-gray-400">({{count}})</span>
            </label>
          `,
        },
      }),

      instantsearch.widgets.refinementList({
        container: "#condition-filter",
        attribute: "offers.condition",
        transformItems(items) {
          return items.map((item) => ({
            ...item,
            label: item.label.charAt(0).toUpperCase() + item.label.slice(1),
          }));
        },
        templates: {
          item: `
            <label class="flex items-center gap-2 cursor-pointer py-1 group">
              <input type="checkbox" class="rounded border-gray-300" {{#isRefined}}checked{{/isRefined}} />
              <span class="text-sm {{#isRefined}}font-bold text-blue-600{{/isRefined}} group-hover:text-blue-500">{{label}}</span>
              <span class="text-[10px] text-gray-400">({{count}})</span>
            </label>
          `,
        },
      }),

      instantsearch.widgets.hits({
        container: "#hits",
        templates: {
          item: (hit) => {
            const displayTitle = hit.title_h1.replace("Refurbished ", "");

            return `
            <div class="p-4 border border-gray-100 mb-3 bg-white rounded-2xl shadow-sm flex items-center gap-6 hover:border-blue-600 transition-all group">
              <!-- Compacte Product Foto -->
              <div class="w-16 h-16 flex-shrink-0 bg-gray-50 rounded-xl overflow-hidden flex items-center justify-center p-2">
                <img 
                  src="https://img.findrefurbished.com/${hit.master_id}.png" 
                  alt="${displayTitle}"
                  width="64" height="64" loading="lazy"
                  class="max-w-full max-h-full object-contain group-hover:scale-105 transition-transform duration-300"
                  onerror="this.src='https://placehold.co/200x200?text=Geen+Foto'" 
                />
              </div>

              <!-- Tekstuele info -->
              <div class="flex-grow">
                <div class="text-[10px] text-blue-600 font-black uppercase tracking-[0.15em] mb-1">${hit.brand}</div>
                <h2 class="font-bold text-gray-900 leading-tight group-hover:text-blue-600 transition-colors text-base">
                  Refurbished ${displayTitle}
                </h2>
              </div>

              <!-- Prijs & Knop -->
              <div class="text-right flex flex-col items-end">
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter leading-none mb-1">Vanaf</span>
                <div class="text-2xl font-black text-gray-900 leading-none">
                  €${Number(hit.min_price).toFixed(2)}
                </div>
                <a href="/product/${hit.variant_slug}" class="mt-3 inline-block bg-gray-900 text-white px-5 py-2 rounded-xl font-bold text-[11px] hover:bg-blue-600 transition-colors shadow-sm">
                  Vergelijk
                </a>
              </div>
            </div>
            `;
          },
          empty:
            '<div class="p-10 text-center text-gray-500 italic">❌ Geen producten gevonden.</div>',
        },
      }),
    ]); // Sluit de widgets array en de addWidgets functie

    search.start();
  }

  // Zorgt dat de zoekmachine start bij laden en bij pagina-wissels
  window.addEventListener("load", startSearch);
  document.addEventListener("astro:page-load", startSearch);
</script>
