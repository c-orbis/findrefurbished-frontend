---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Vind Refurbished - Vergelijk alle prijzen">
  <main class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-4xl font-black mb-8 text-gray-900 leading-tight tracking-tight">Vind Refurbished</h1>
    
    <!-- Zoekbalk -->
    <div id="searchbox" class="mb-8"></div>

    <div class="flex flex-col md:flex-row gap-10">
      <!-- Sidebar voor filters -->
      <aside class="w-full md:w-64 space-y-6">
        <div>
          <h3 class="font-bold mb-2 text-gray-400 uppercase text-xs tracking-widest italic">Merk</h3>
          <div id="brand-filter"></div>
        </div>
      </aside>

      <!-- Resultaten -->
      <div class="flex-grow">
        <div id="hits"></div>
      </div>
    </div>
  </main>

  <!-- Data element (slechts één keer nodig) -->
  <div id="meili-data" 
       data-host={import.meta.env.PUBLIC_MEILI_HOST} 
       data-key={import.meta.env.PUBLIC_MEILI_SEARCH_KEY}>
  </div>
</Layout>

<script>
  // We importeren de software direct uit de node_modules (die Vercel voor je installeert)
  import { instantMeiliSearch } from '@meilisearch/instant-meilisearch';
  import instantsearch from 'instantsearch.js';
  import { searchBox, hits, refinementList } from 'instantsearch.js/es/widgets';

  async function init() {
    const dataEl = document.getElementById('meili-data');
    if (!dataEl) return;

    const host = dataEl.dataset.host?.replace('http://', 'https://');
    const key = dataEl.dataset.key;

    console.log("--- STARTING ENGINE ---");

    try {
      // We maken de client aan via de officieel gebundelde SDK
      const searchClient = instantMeiliSearch(host, key);

      const search = instantsearch({
        indexName: 'products',
        searchClient,
        future: { preserveSharedStateOnUnmount: true }
      });

      search.addWidgets([
        searchBox({ container: '#searchbox', placeholder: 'Zoek op model...' }),
        refinementList({ container: '#brand-filter', attribute: 'brand' }),
        hits({
          container: '#hits',
          templates: {
            item: (hit) => `
              <div class="p-4 border mb-2 bg-white rounded-xl shadow-sm flex items-center gap-4 group hover:border-blue-500 transition-all">
                <img src="https://img.findrefurbished.com$/{hit.master_id}.png" class="w-16 h-16 object-contain" onerror="this.src='https://placehold.co'" />
                <div class="flex-grow">
                  <div class="font-bold text-gray-900 leading-tight">${hit.title_h1}</div>
                  <div class="text-[10px] text-gray-400 uppercase font-bold tracking-widest mt-1">${hit.brand}</div>
                </div>
                <div class="text-right min-w-[100px]">
                  <div class="text-3xl font-black text-blue-600">€${Number(hit.min_price).toFixed(2)}</div>
                  <a href="/product/${hit.variant_slug}" class="inline-block mt-2 text-xs font-bold text-blue-500 hover:underline">Bekijk deals</a>
                </div>
              </div>
            `,
            empty: '<div class="p-10 text-center text-gray-500">❌ Geen producten gevonden.</div>'
          }
        })
      ]);

      search.start();
      console.log("Engine is running successfully!");
    } catch (err) {
      console.error("Engine failed to start:", err);
    }
  }

  // Luister naar Astro's page load event (voor View Transitions)
  document.addEventListener('astro:page-load', init);
  // Initialiseer direct voor de eerste load
  init();
</script>
