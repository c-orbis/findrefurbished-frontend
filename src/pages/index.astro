---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Vind Refurbished - Vergelijk alle prijzen">
  <main class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-4xl font-black mb-8 text-gray-900 leading-tight tracking-tight">Vind Refurbished</h1>
    
    <!-- Zoekbalk -->
    <div id="searchbox" class="mb-8"></div>

    <div class="flex flex-col md:flex-row gap-10">
      <!-- Sidebar voor filters -->
      <aside class="w-full md:w-64 space-y-8">
        <div>
          <h3 class="font-bold mb-4 text-gray-900 uppercase text-[10px] tracking-widest italic border-b pb-2 border-gray-100">Merk</h3>
          <div id="brand-filter"></div>
        </div>
        
        <div>
          <h3 class="font-bold mb-4 text-gray-900 uppercase text-[10px] tracking-widest italic border-b pb-2 border-gray-100">Conditie</h3>
          <div id="condition-filter"></div>
        </div>
      </aside>

      <!-- Resultaten -->
      <div class="flex-grow">
        <div id="hits"></div>
      </div>
    </div>
  </main>

  <!-- Data element (slechts √©√©n keer nodig) -->
  <div id="meili-data" 
       data-host={import.meta.env.PUBLIC_MEILI_HOST} 
       data-key={import.meta.env.PUBLIC_MEILI_SEARCH_KEY}>
  </div>
</Layout>

<!-- 1. Laad de bibliotheken direct via CDN -->
<script is:inline src="https://cdn.jsdelivr.net/npm/@meilisearch/instant-meilisearch/dist/instant-meilisearch.umd.min.js"></script>
<script is:inline src="https://cdn.jsdelivr.net/npm/instantsearch.js@4"></script>

<script is:inline>
  async function startSearch() {
    const dataEl = document.getElementById('meili-data');
    if (!dataEl) return;

    // Forceer HTTPS voor de API aanroep
    const host = dataEl.dataset.host.replace('http://', 'https://');
    const key = dataEl.dataset.key;

    // Handmatige SearchClient om Astro-bundler fouten te omzeilen
            const searchClient = {
      async search(requests) {
        // InstantSearch kan meerdere verzoeken tegelijk sturen (bijv. voor hits en voor facetten)
        const responses = await Promise.all(
          requests.map(async (request) => {
            const { indexName, params } = request;
            
            // Haal de filters op. Let op: we gebruiken params.filters direct
            const filterString = params.filters ? params.filters.replace(/:/g, ' = ') : "";
            
            console.log("Verzoek voor", indexName, "| Filter:", filterString);

            const res = await fetch(`${host}/indexes/${indexName}/search`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${key}`
              },
              body: JSON.stringify({
                q: params.query || "",
                limit: 20,
                filter: filterString,
                facets: ["brand", "offers.condition"]
              })
            });

            const data = await res.json();

            return {
              hits: data.hits,
              nbHits: data.estimatedTotalHits || data.hits.length,
              nbPages: 1,
              page: 0,
              processingTimeMS: data.processingTimeMs,
              hitsPerPage: 20,
              query: params.query,
              facets: data.facetDistribution,
              exhaustiveNbHits: true
            };
          })
        );

        return { results: responses };
      }
    };


    const search = instantsearch({
      indexName: 'products',
      searchClient: searchClient,
    });

    search.addWidgets([
      // Zoekbalk
      instantsearch.widgets.searchBox({ 
        container: '#searchbox', 
        placeholder: 'Zoek op model (bijv. iPhone 15 Pro)...' 
      }),

      // Merk Filter
      instantsearch.widgets.refinementList({
        container: '#brand-filter',
        attribute: 'brand',
        templates: {
          item: `
            <label class="flex items-center gap-2 cursor-pointer py-1 group">
              <input type="checkbox" class="rounded border-gray-300" {{#isRefined}}checked{{/isRefined}} />
              <span class="text-sm {{#isRefined}}font-bold text-blue-600{{/isRefined}} group-hover:text-blue-500">{{label}}</span>
              <span class="text-[10px] text-gray-400">({{count}})</span>
            </label>
          `,
        },
      }),

      // Conditie Filter
      instantsearch.widgets.refinementList({
        container: '#condition-filter',
        attribute: 'offers.condition',
        transformItems(items) {
          return items.map(item => ({
            ...item,
            label: item.label.charAt(0).toUpperCase() + item.label.slice(1),
          }));
        },
        templates: {
          item: `
            <label class="flex items-center gap-2 cursor-pointer py-1 group">
              <input type="checkbox" class="rounded border-gray-300" {{#isRefined}}checked{{/isRefined}} />
              <span class="text-sm {{#isRefined}}font-bold text-blue-600{{/isRefined}} group-hover:text-blue-500">{{label}}</span>
              <span class="text-[10px] text-gray-400">({{count}})</span>
            </label>
          `,
        },
      }),

      // Resultatenlijst
      instantsearch.widgets.hits({
        container: '#hits',
        templates: {
          item: (hit) => `
            <div class="p-4 border border-gray-200 mb-2 bg-white rounded-xl shadow-sm flex items-center gap-4 hover:border-blue-500 transition-colors group">
              <img src="https://img.findrefurbished.com/${hit.master_id}.png" class="w-16 h-16 object-contain" onerror="this.src='https://placehold.co/200x200?text=Geen+Foto'" />
              <div class="flex-grow">
                <div class="font-bold text-gray-900 leading-tight group-hover:text-blue-600 transition-colors">${hit.title_h1}</div>
                <div class="text-[10px] text-gray-400 uppercase font-bold tracking-widest mt-1">${hit.brand}</div>
              </div>
              <div class="text-right min-w-[100px]">
                <div class="text-2xl font-black text-blue-600 leading-none">‚Ç¨${Number(hit.min_price).toFixed(2)}</div>
                <a href="/product/${hit.variant_slug}" class="inline-block mt-2 text-[11px] text-blue-600 font-bold hover:underline italic">Bekijk deals</a>
              </div>
            </div>
          `,
          empty: '<div class="p-10 text-center text-gray-500 italic">‚ùå Geen producten gevonden.</div>'
        }
      })
    ]);

    search.start();
    console.log("üöÄ Zoekmachine inclusief filters operationeel!");
  }

  // Initialisatie bij laden en Astro transities
  window.addEventListener('load', startSearch);
  document.addEventListener('astro:page-load', startSearch);
</script>

