---
import Layout from '../../layouts/Layout.astro';

// 1. Haal de gegevens uit de URL en de omgeving
const { slug } = Astro.params;
const host = import.meta.env.PUBLIC_MEILI_HOST;
const key = import.meta.env.PUBLIC_MEILI_SEARCH_KEY;

let debugInfo = null;
let product = null;

// 2. Voer de zoekopdracht uit op de server
try {
  // We plakken de key direct achter de URL
const response = await fetch(`${host}/indexes/products/search?apiKey=${import.meta.env.PUBLIC_MEILI_SEARCH_KEY}`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
    // Je mag de Authorization header hier zelfs weglaten!
  },
  body: JSON.stringify({
    filter: `variant_slug = "${slug}"`,
    limit: 1
  })
});


debugInfo = await response.json();
  
  if (debugInfo.hits && debugInfo.hits.length > 0) {
    product = debugInfo.hits[0]; // Pak het eerste product
  }
} catch (e) {
  debugInfo = { error: e.message };
}

// Sorteer de aanbiedingen als het product gevonden is
const sortedOffers = product?.offers?.sort((a, b) => a.price - b.price) || [];
---

<Layout title={product ? `${product.title_h1} Vergelijken` : "Product niet gevonden"}>
  <main class="p-10 max-w-5xl mx-auto">
    <!-- Hieronder komt je HTML die we eerder hebben gemaakt -->
    {!product ? (
      <div class="bg-red-50 p-8 border border-red-200 rounded-xl">
         <h1 class="text-red-600 font-bold text-2xl mb-4">Product niet gevonden!</h1>
         <pre class="bg-gray-900 text-green-400 p-4 rounded overflow-auto text-xs">
           {JSON.stringify(debugInfo, null, 2)}
         </pre>
      </div>
    ) : (
      <div>
        <h1 class="text-4xl font-black">{product.title_h1}</h1>
        <!-- De rest van de product weergave... -->
      </div>
    )}
  </main>
</Layout>
