---
import Layout from '../../layouts/Layout.astro';

const { slug } = Astro.params;

// Veilig ophalen van de variabelen uit Vercel
const host = import.meta.env.PUBLIC_MEILI_HOST;
const serverKey = import.meta.env.MEILI_SERVER_KEY;
const publicKey = import.meta.env.PUBLIC_MEILI_SEARCH_KEY;

// Kies de sleutel die beschikbaar is
const key = serverKey || publicKey;

// Debug log: Dit zie je in je Vercel Logs tabblad om te checken of de key geladen is
console.log("Sleutel geladen:", key ? "JA (begint met " + key.substring(0,4) + ")" : "NEE");
let product = null;

try {
  const response = await fetch(`${host}/indexes/products/search`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${key}`
    },
    body: JSON.stringify({
      filter: `variant_slug = '${slug}'`,
      limit: 1
    })
  });

  const data = await response.json();
  if (data.hits && data.hits.length > 0) {
    product = data.hits[0];
  }
} catch (e) {
  console.error("Fetch error:", e);
}

// Als het product echt niet bestaat, stuur naar 404
if (!product) {
  return Astro.redirect('/404');
}

const sortedOffers = product.offers?.sort((a, b) => Number(a.price) - Number(b.price)) || [];
---

<Layout title={`${product.title_h1} Vergelijken - Vind Refurbished`}>
  <main class="max-w-5xl mx-auto px-4 py-12 text-gray-900">
    <!-- Product Header -->
    <div class="grid md:grid-cols-2 gap-12 mb-16 items-center">
      <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm flex justify-center hover:shadow-lg transition-shadow duration-300">
        <img 
          src={`https://img.findrefurbished.com/${product.master_id}.png`} 
          alt={product.title_h1}
          class="max-h-[400px] w-auto object-contain"
          onerror="this.src='https://placehold.co/200x200?text=Geen+Foto'"
        />
      </div>
      
      <div>
        <nav class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.2em] mb-4">
          <a href="/" class="hover:text-blue-600 transition-colors">Home</a> / {product.brand}
        </nav>
        <h1 class="text-4xl md:text-5xl font-black text-gray-900 mb-6 leading-tight tracking-tight">{product.title_h1}</h1>
        
        <div class="inline-flex items-center gap-4 bg-blue-50 border border-blue-100 p-6 rounded-3xl">
          <div>
            <span class="text-[10px] uppercase font-bold text-blue-500 block mb-1 tracking-widest text-center">Beste prijs</span>
            <span class="text-4xl font-black text-blue-600">€{Number(product.min_price).toFixed(2)}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Prijstabel -->
    <h2 class="text-2xl font-black text-gray-900 mb-8 tracking-tight italic">Beschikbare prijzen</h2>
    
    <div class="space-y-4">
      {sortedOffers.map((offer) => (
        <div class="bg-white border border-gray-100 p-6 rounded-2xl flex flex-col md:flex-row items-center justify-between gap-6 hover:border-blue-500 transition-all shadow-sm">
          <div class="flex-grow">
            <div class="font-black text-xl text-gray-900 mb-1">{offer.merchant}</div>
            <div class="flex gap-2">
              <span class="text-[9px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full font-bold uppercase tracking-tighter italic">{offer.condition}</span>
              <span class="text-[9px] bg-blue-50 text-blue-500 px-2 py-0.5 rounded-full font-bold uppercase tracking-tighter italic">{offer.color}</span>
            </div>
          </div>

          <div class="flex items-center gap-8 w-full md:w-auto justify-between md:justify-end border-t md:border-t-0 pt-4 md:pt-0">
            <div class="text-right">
              <div class="text-2xl font-black text-gray-900">€{Number(offer.price).toFixed(2)}</div>
              <div class="text-[9px] text-green-500 font-bold uppercase tracking-widest mt-1 italic">Op voorraad</div>
            </div>
            <a 
              href={offer.link} 
              target="_blank" 
              rel="nofollow" 
              class="bg-gray-900 text-white px-8 py-3 rounded-xl font-bold text-sm hover:bg-blue-600 transition-all shadow-lg shadow-gray-100"
            >
              Bekijk deal
            </a>
          </div>
        </div>
      ))}
    </div>
  </main>
</Layout>
